var X=512;var u=80;var L=64;var Y=32;var z=[240,144,144,144,240,32,96,32,32,112,240,16,240,128,240,240,16,240,16,240,144,144,240,16,16,240,128,240,16,240,240,128,240,144,240,240,16,32,64,64,240,144,240,144,240,240,144,240,16,240,240,144,240,144,144,224,144,224,144,224,240,128,128,128,240,224,144,144,144,224,240,128,240,128,240,240,128,240,128,128];var A={49:1,50:2,51:3,52:12,81:4,87:5,69:6,82:13,65:7,83:8,68:9,70:14,90:10,88:0,67:11,86:15};class J{constructor(x=10,F=10){this.canvas=document.getElementById("app");this.ctx=this.canvas.getContext("2d");this.scale=x;this.pixelSize=F;this.canvas.width=L*this.scale;this.canvas.height=Y*this.scale}render(x){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);for(let F=0;F<L;F++){for(let t=0;t<Y;t++){const g=x[F+t*L];if(g){this.ctx.fillStyle="#212f3d";this.ctx.fillRect(F*this.scale,t*this.scale,this.pixelSize,this.pixelSize)}}}}}class E{keysPressed;nextKeyCallback;constructor(x){this.keysMap=x;this.keysPressed={};this.nextKeyCallback=null;this.init()}init(){window.addEventListener("keydown",this.onKeyDown.bind(this),false);window.addEventListener("keyup",this.onKeyRelease.bind(this),false)}}E.prototype.isKeyPressed=function(x){return this.keysPressed[x]};E.prototype.onKeyDown=function(x){const F=x?.keyCode;const t=this.keysMap[F];if(!t)return;this.keysPressed[t]=true;if(this.nextKeyCallback&&t){this.nextKeyCallback(t);this.nextKeyCallback=null}};E.prototype.onKeyRelease=function(x){const F=x?.keyCode;const t=this.keysMap[F];this.keysPressed[t]=false};class P{audioContext;gain;destination;constructor(){this.audioContext=new window.AudioContext;this.gain=this.audioContext.createGain();this.destination=this.audioContext.destination;this.gain.connect(this.destination)}}P.prototype.play=function(){if(this.audioContext&&!this.oscillator){this.oscillator=this.audioContext.createOscillator();this.oscillator.frequency.setValueAtTime(440,this.audioContext.currentTime);this.oscillator.type="square";this.oscillator.connect(this.gain);this.oscillator.start()}};P.prototype.stop=function(){if(this.oscillator){this.oscillator.stop();this.oscillator.disconnect();this.oscillator=null}};class q{constructor(x,F,t){this.memory=new Uint8Array(4096);this.registers=new Uint8Array(16);this.stack=new Array;this.pc=X;this.video=new Array(L*Y);this.sp=0;this.i=0;this.delayTimer=0;this.soundTimer=0;this.paused=false;this.keyboard=x;this.sound=F;this.display=t}loadFontsetInMemory(){for(let x=0;x<z.length;x++){this.memory[u+x]=z[x]}}cycle(){if(!this.paused){let x=this.memory[this.pc]<<8|this.memory[this.pc+1];this.instructions(x);if(this.delayTimer>0){this.delayTimer-=1}if(this.soundTimer>0){this.soundTimer-=1}}if(this.soundTimer>0){this.sound.play()}else{this.sound.stop()}this.display.render(this.video)}increment_pc(){this.pc+=2}rand(){return Math.floor(Math.random()*255)}clearDisplay(){this.video=new Array(L*Y)}instructions(x){this.increment_pc();const F=(x&3840)>>8;const t=(x&240)>>4;const g=128;const f=8;const C=this.registers[F];const G=this.registers[t];const m=x&15;switch(x&61440){case 0:{this.op_0(x)}break;case 4096:{const h=x&4095;this.pc=h}break;case 8192:{const h=x&4095;this.stack.push(this.pc);this.pc=h}break;case 12288:{const h=x&255;if(this.registers[F]===h){this.increment_pc()}}break;case 16384:{const h=x&255;if(this.registers[F]!==h){this.increment_pc()}}break;case 20480:{if(this.registers[F]===this.registers[t]){this.increment_pc()}}break;case 24576:{const h=x&255;this.registers[F]=h}break;case 28672:{const h=x&255;this.registers[F]+=h}break;case 32768:{const h=x&15;switch(h){case 0:{this.registers[F]=this.registers[t]}break;case 1:{this.registers[F]|=this.registers[t]}break;case 2:{this.registers[F]&=this.registers[t]}break;case 3:{this.registers[F]^=this.registers[t]}break;case 4:{this.registers[15]=0;const B=this.registers[F]+this.registers[t];if(B>255){this.registers[15]=1}this.registers[F]=B}break;case 5:{this.registers[15]=0;if(this.registers[F]>this.registers[t]){this.registers[15]=1}this.registers[F]-=this.registers[t]}break;case 6:{this.registers[15]=this.registers[F]&1;this.registers[F]>>=1}break;case 7:{this.registers[15]=0;if(this.registers[t]>this.registers[F]){this.registers[15]=1}this.registers[F]=this.registers[t]-this.registers[F]}break;case 14:{this.registers[15]=(this.registers[F]&128)>>7;this.registers[F]<<=1}break}}break;case 36864:{if(this.registers[F]!==this.registers[t]){this.increment_pc()}}break;case 40960:{const h=x&4095;this.i=h}break;case 45056:{const h=x&4095;this.pc=this.registers[0]+h}break;case 49152:{const h=x&255;const B=this.rand();this.registers[F]=B&h}break;case 53248:{this.registers[15]=0;for(let h=0;h<m;h++){let B=this.memory[this.i+h];for(let Q=0;Q<f;Q++){if((B&g>>Q)!==0){const R=C+Q;const j=G+h;const v=R+j*L;if(this.video[v]===1){this.registers[15]=1}this.video[v]^=1}}}}break;case 57344:{const h=x&255;switch(h){case 158:{if(this.keyboard.isKeyPressed(this.registers[F])){this.increment_pc()}}break;case 161:{if(!this.keyboard.isKeyPressed(this.registers[F])){this.increment_pc()}}break}}break;case 61440:{const h=x&255;switch(h){case 7:{this.registers[F]=this.delayTimer}break;case 10:{this.paused=true;this.keyboard.nextKeyCallback=(B)=>{this.registers[F]=B;this.paused=false}}break;case 21:{this.delayTimer=this.registers[F]}break;case 24:{this.soundTimer=this.registers[F]}break;case 30:{this.i+=this.registers[F]}break;case 41:{this.i=this.registers[F]*5}break;case 51:{let B=this.registers[F];this.memory[this.i]=Math.floor(B/100);this.memory[this.i+1]=Math.floor(B%100/10);this.memory[this.i+2]=Math.floor(B%10)}break;case 85:{for(let B=0;B<=F;B++){this.memory[this.i+B]=this.registers[B]}}break;case 101:{for(let B=0;B<=F;B++){this.registers[B]=this.memory[this.i+B]}}break}}break}}}q.prototype.op_0=function(x){switch(x){case 224:{this.clearDisplay()}break;case 238:{this.pc=this.stack.pop()}break}};class Z{cpu;constructor(x,F,t){this.keyboard=x;this.sound=F;this.display=t;this.cpu=new q(this.keyboard,this.sound,this.display);this.currentRom=null;this.elapsed=0;this.lastTimestamp=0;this.fixedFPS=1000/60;this.tick=this.tick.bind(this)}loadRomBufferInMemory(x){for(let F=0;F<x.length;F++){this.cpu.memory[X+F]=x[F]}}async fetchRom(x){this.currentRom=x;const F=await fetch(`roms/${x}.ch8`);const t=await F.arrayBuffer();this.loadRomBufferInMemory(new Uint8Array(t))}init(x){this.cpu.loadFontsetInMemory();this.fetchRom(x)}clear(){this.cpu.clearDisplay();this.cpu=new q(this.keyboard,this.sound,this.display)}onScaleChange(x){this.cpu.display.scale=x;this.cpu.display.pixelSize=x;this.cpu.display.canvas.width=L*x;this.cpu.display.canvas.height=Y*x}togglePause(){const x=this.cpu.paused;this.cpu.paused=!x}drawInfo(){appTimerInterval.innerText=Math.floor(this.fixedFPS)+"ms";appTimerElapsed.innerText=this.elapsed+"s";appTimerDelay.innerText=this.cpu.delayTimer}tick(x){const F=x-this.lastTimestamp;this.lastTimestamp=x;if(!this.elapsed){this.elapsed=0}this.elapsed+=F;while(this.elapsed>=this.fixedFPS){this.elapsed-=this.fixedFPS}this.drawInfo();this.cpu.cycle();requestAnimationFrame(this.tick)}}var $=new URLSearchParams(document.location.search);var W=document.getElementById("scale");var U=document.getElementById("roms");var K=document.getElementById("pauseBtn");var r=new E(A);var l=new P;var w=new J;var n=new Z(r,l,w);var M="blitz";if($.has("rom")){M=$.get("rom");U.value=M}n.init(M);document.addEventListener("DOMContentLoaded",()=>{n.tick()});W.addEventListener("change",(x)=>{n.onScaleChange(parseInt(x.target.value))});U.addEventListener("change",(x)=>{n.clear();$.set("rom",x.target.value);document.location.search=$.toString();n.init(x.target.value)});K.addEventListener("change",(x)=>{n.cpu.paused=x.target.checked;K.nextElementSibling.innerText=n.cpu.paused?"Play":"Pause"});
