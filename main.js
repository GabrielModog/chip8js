var U=512;var C=80;var J=64;var X=32;var G=60;var M=[240,144,144,144,240,32,96,32,32,112,240,16,240,128,240,240,16,240,16,240,144,144,240,16,16,240,128,240,16,240,240,128,240,144,240,240,16,32,64,64,240,144,240,144,240,240,144,240,16,240,240,144,240,144,144,224,144,224,144,224,240,128,128,128,240,224,144,144,144,224,240,128,240,128,240,240,128,240,128,128];var K={49:1,50:2,51:3,52:12,81:4,87:5,69:6,82:13,65:7,83:8,68:9,70:14,90:10,88:0,67:11,86:15};class Z{constructor(F=10,x=10){this.canvas=document.getElementById("app");this.ctx=this.canvas.getContext("2d");this.scale=F;this.pixelSize=x;this.canvas.width=J*this.scale;this.canvas.height=X*this.scale}render(F){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);for(let x=0;x<J;x++){for(let Y=0;Y<X;Y++){const q=F[x+Y*J];if(q){this.ctx.fillStyle="#000";this.ctx.fillRect(x*this.scale,Y*this.scale,this.pixelSize,this.pixelSize)}}}}}class L{keysPressed;nextKeyCallback;constructor(F){this.keysMap=F;this.keysPressed={};this.nextKeyCallback=null;this.init()}init(){window.addEventListener("keydown",this.onKeyDown.bind(this),false);window.addEventListener("keyup",this.onKeyRelease.bind(this),false)}}L.prototype.isKeyPressed=function(F){return this.keysPressed[F]};L.prototype.onKeyDown=function(F){const x=F?.keyCode;const Y=this.keysMap[x];if(!Y)return;this.keysPressed[Y]=true;if(this.nextKeyCallback&&Y){this.nextKeyCallback(Y);this.nextKeyCallback=null}};L.prototype.onKeyRelease=function(F){const x=F?.keyCode;const Y=this.keysMap[x];this.keysPressed[Y]=false};class Q{audioContext;gain;destination;constructor(){this.audioContext=new window.AudioContext;this.gain=this.audioContext.createGain();this.destination=this.audioContext.destination;this.gain.connect(this.destination)}}Q.prototype.play=function(){if(this.audioContext&&!this.oscillator){this.oscillator=this.audioContext.createOscillator();this.oscillator.frequency.setValueAtTime(440,this.audioContext.currentTime);this.oscillator.type="square";this.oscillator.connect(this.gain);this.oscillator.start()}};Q.prototype.stop=function(){if(this.oscillator){this.oscillator.stop();this.oscillator.disconnect();this.oscillator=null}};class h{constructor(F,x,Y){this.memory=new Uint8Array(4096);this.registers=new Uint8Array(16);this.stack=new Array;this.pc=U;this.video=new Array(J*X);this.sp=0;this.i=0;this.delayTimer=0;this.soundTimer=0;this.paused=false;this.speed=10;this.keyboard=F;this.sound=x;this.display=Y}loadFontsetInMemory(){for(let F=0;F<M.length;F++){this.memory[C+F]=M[F]}}cycle(){if(!this.paused){let F=this.memory[this.pc]<<8|this.memory[this.pc+1];this.instructions(F);if(this.delayTimer>0){this.delayTimer-=1}if(this.soundTimer>0){this.soundTimer-=1}}if(this.soundTimer>0){this.sound.play()}else{this.sound.stop()}this.display.render(this.video)}increment_pc(){this.pc+=2}rand(){return Math.floor(Math.random()*255)}clearDisplay(){this.video=new Array(J*X)}instructions(F){this.increment_pc();let x=(F&3840)>>8;let Y=(F&240)>>4;switch(F&61440){case 0:{switch(F){case 224:{this.clearDisplay()}break;case 238:{this.pc=this.stack.pop()}break}}break;case 4096:{const q=F&4095;this.pc=q}break;case 8192:{const q=F&4095;this.stack.push(this.pc);this.pc=q}break;case 12288:{const q=F&255;if(this.registers[x]===q){this.increment_pc()}}break;case 16384:{const q=F&255;if(this.registers[x]!==q){this.increment_pc()}}break;case 20480:{if(this.registers[x]===this.registers[Y]){this.increment_pc()}}break;case 24576:{const q=F&255;this.registers[x]=q}break;case 28672:{const q=F&255;this.registers[x]+=q}break;case 32768:{const q=F&15;switch(q){case 0:{this.registers[x]=this.registers[Y]}break;case 1:{this.registers[x]|=this.registers[Y]}break;case 2:{this.registers[x]&=this.registers[Y]}break;case 3:{this.registers[x]^=this.registers[Y]}break;case 4:{this.registers[15]=0;const B=this.registers[x]+this.registers[Y];if(B>255){this.registers[15]=1}this.registers[x]=B}break;case 5:{this.registers[15]=0;if(this.registers[x]>this.registers[Y]){this.registers[15]=1}this.registers[x]-=this.registers[Y]}break;case 6:{this.registers[15]=this.registers[x]&1;this.registers[x]>>=1}break;case 7:{this.registers[15]=0;if(this.registers[Y]>this.registers[x]){this.registers[15]=1}this.registers[x]=this.registers[Y]-this.registers[x]}break;case 14:{this.registers[15]=(this.registers[x]&128)>>7;this.registers[x]<<=1}break}}break;case 36864:{if(this.registers[x]!==this.registers[Y]){this.increment_pc()}}break;case 40960:{const q=F&4095;this.i=q}break;case 45056:{const q=F&4095;this.pc=this.registers[0]+q}break;case 49152:{const q=F&255;const B=this.rand();this.registers[x]=B&q}break;case 53248:{this.registers[15]=0;const q=128;const B=8;const E=this.registers[x];const N=this.registers[Y];let W=F&15;for(let $=0;$<W;$++){let j=this.memory[this.i+$];for(let P=0;P<B;P++){if((j&q>>P)!==0){const R=E+P;const f=N+$;const w=R+f*J;if(this.video[w]===1){this.registers[15]=1}this.video[w]^=1}}}}break;case 57344:{const q=F&255;switch(q){case 158:{if(this.keyboard.isKeyPressed(this.registers[x])){this.increment_pc()}}break;case 161:{if(!this.keyboard.isKeyPressed(this.registers[x])){this.increment_pc()}}break}}break;case 61440:{const q=F&255;switch(q){case 7:{this.registers[x]=this.delayTimer}break;case 10:{this.paused=true;this.keyboard.nextKeyCallback=(B)=>{this.registers[x]=B;this.paused=false}}break;case 21:{this.delayTimer=this.registers[x]}break;case 24:{this.soundTimer=this.registers[x]}break;case 30:{this.i+=this.registers[x]}break;case 41:{this.i=this.registers[x]*5}break;case 51:{let B=this.registers[x];this.memory[this.i]=Math.floor(B/100);this.memory[this.i+1]=Math.floor(B%100/10);this.memory[this.i+2]=Math.floor(B%10)}break;case 85:{for(let B=0;B<=x;B++){this.memory[this.i+B]=this.registers[B]}}break;case 101:{for(let B=0;B<=x;B++){this.registers[B]=this.memory[this.i+B]}}break}}break}}}class z{cpu;constructor(F,x,Y){this.cpu=new h(F,x,Y);this.freeze=false;this.interval=0;this.now=0;this.lastTime=0;this.elapsed=0}loadRomBufferInMemory(F){for(let x=0;x<F.length;x++){this.cpu.memory[U+x]=F[x]}}async fetchRom(F="blitz.ch8"){const x=await fetch(`roms/${F}`);const Y=await x.arrayBuffer();this.loadRomBufferInMemory(new Uint8Array(Y))}init(){this.interval=1000/G;this.lastTime=Date.now();this.cpu.loadFontsetInMemory();this.fetchRom()}run(){this.now=Date.now();this.elapsed=this.now-this.lastTime;if(this.elapsed>=this.interval){this.cpu.cycle()}requestAnimationFrame(this.run.bind(this))}}var m=new L(K);var S=new Q;var V=new Z;var A=new z(m,S,V);A.init();A.run();
