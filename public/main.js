var U=512;var G=80;var L=64;var Q=32;var C=60;var z=[240,144,144,144,240,32,96,32,32,112,240,16,240,128,240,240,16,240,16,240,144,144,240,16,16,240,128,240,16,240,240,128,240,144,240,240,16,32,64,64,240,144,240,144,240,240,144,240,16,240,240,144,240,144,144,224,144,224,144,224,240,128,128,128,240,224,144,144,144,224,240,128,240,128,240,240,128,240,128,128];var w={49:1,50:2,51:3,52:12,81:4,87:5,69:6,82:13,65:7,83:8,68:9,70:14,90:10,88:0,67:11,86:15};class Z{constructor(F=10,x=10){this.canvas=document.getElementById("app");this.ctx=this.canvas.getContext("2d");this.scale=F;this.pixelSize=x;this.canvas.width=L*this.scale;this.canvas.height=Q*this.scale}render(F){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);for(let x=0;x<L;x++){for(let q=0;q<Q;q++){const B=F[x+q*L];if(B){this.ctx.fillStyle="#000";this.ctx.fillRect(x*this.scale,q*this.scale,this.pixelSize,this.pixelSize)}}}}}class M{keysPressed;setPressedKey;constructor(){this.keysPressed={};this.setPressedKey=null;this.init()}}M.prototype.isKeyPressed=function(F){return this.keysPressed[F]};M.prototype.onKeyDown=function(F){const x=F?.keyCode||F?.key.toUpperCase().charCodeAt(0);const q=w[x];this.keysPressed[q]=true;if(this.setPressedKey&&q){this.setPressedKey(q);this.setPressedKey=null}};M.prototype.onKeyRelease=function(F){const x=F?.keyCode||F?.key.charCodeAt(0);const q=w[x];this.keysPressed[q]=false};M.prototype.init=function(){window.addEventListener("keydown",this.onKeyDown.bind(this),false);window.addEventListener("keyup",this.onKeyRelease.bind(this),false)};class X{audioContext;gain;destination;constructor(){this.audioContext=new window.AudioContext;this.gain=this.audioContext.createGain();this.destination=this.audioContext.destination;this.gain.connect(this.destination)}}X.prototype.play=function(){if(this.audioContext&&!this.oscillator){this.oscillator=this.audioContext.createOscillator();this.oscillator.frequency.setValueAtTime(440,this.audioContext.currentTime);this.oscillator.type="square";this.oscillator.connect(this.gain);this.oscillator.start()}};X.prototype.stop=function(){if(this.oscillator){this.oscillator.stop();this.oscillator.disconnect();this.oscillator=null}};class Y{constructor(F,x,q){this.memory=new Uint8Array(4096);this.registers=new Uint8Array(16);this.stack=new Array;this.pc=U;this.video=new Array(L*Q);this.sp=0;this.i=0;this.delayTimer=0;this.soundTimer=0;this.paused=false;this.speed=10;this.keyboard=F;this.sound=x;this.display=q}loadFontsetInMemory(){for(let F=0;F<z.length;F++){this.memory[G+F]=z[F]}}cycle(){if(!this.paused){let F=this.memory[this.pc]<<8|this.memory[this.pc+1];this.instructions(F);if(this.delayTimer>0){this.delayTimer-=1}if(this.soundTimer>0){this.soundTimer-=1}}if(this.soundTimer>0){this.sound.play()}else{this.sound.stop()}this.display.render(this.video)}increment_pc(){this.pc+=2}rand(){return Math.floor(Math.random()*255)}clearDisplay(){this.video=new Array(L*Q)}instructions(F){this.increment_pc();let x=(F&3840)>>8;let q=(F&240)>>4;switch(F&61440){case 0:{switch(F){case 224:{this.clearDisplay()}break;case 238:{this.pc=this.stack.pop()}break}}break;case 4096:{const B=F&4095;this.pc=B}break;case 8192:{const B=F&4095;this.stack.push(this.pc);this.pc=B}break;case 12288:{const B=F&255;if(this.registers[x]===B){this.increment_pc()}}break;case 16384:{const B=F&255;if(this.registers[x]!==B){this.increment_pc()}}break;case 20480:{if(this.registers[x]===this.registers[q]){this.increment_pc()}}break;case 24576:{const B=F&255;this.registers[x]=B}break;case 28672:{const B=F&255;this.registers[x]+=B}break;case 32768:{const B=F&15;switch(B){case 0:{this.registers[x]=this.registers[q]}break;case 1:{this.registers[x]|=this.registers[q]}break;case 2:{this.registers[x]&=this.registers[q]}break;case 3:{this.registers[x]^=this.registers[q]}break;case 4:{this.registers[15]=0;const J=this.registers[x]+this.registers[q];if(J>255){this.registers[15]=1}this.registers[x]=J}break;case 5:{this.registers[15]=0;if(this.registers[x]>this.registers[q]){this.registers[15]=1}this.registers[x]-=this.registers[q]}break;case 6:{this.registers[15]=this.registers[x]&1;this.registers[x]>>=1}break;case 7:{this.registers[15]=0;if(this.registers[q]>this.registers[x]){this.registers[15]=1}this.registers[x]=this.registers[q]-this.registers[x]}break;case 14:{this.registers[15]=(this.registers[x]&128)>>7;this.registers[x]<<=1}break}}break;case 36864:{if(this.registers[x]!==this.registers[q]){this.increment_pc()}}break;case 40960:{const B=F&4095;this.i=B}break;case 45056:{const B=F&4095;this.pc=this.registers[0]+B}break;case 49152:{const B=F&255;const J=this.rand();this.registers[x]=J&B}break;case 53248:{this.registers[15]=0;const B=128;const J=8;const R=this.registers[x];const W=this.registers[q];let j=F&15;for(let $=0;$<j;$++){let K=this.memory[this.i+$];for(let P=0;P<J;P++){if((K&B>>P)!==0){const f=(R+P)%L;const m=(W+$)%Q;const A=f+m*L;if(this.video[A]===1){this.registers[15]=1}this.video[A]^=1}}}}break;case 57344:{const B=F&255;switch(B){case 158:{if(this.keyboard.isKeyPressed(this.registers[x])){this.increment_pc()}}break;case 161:{if(!this.keyboard.isKeyPressed(this.registers[x])){this.increment_pc()}}break}}break;case 61440:{const B=F&255;switch(B){case 7:{this.registers[x]=this.delayTimer}break;case 10:{this.paused=true;this.keyboard.setPressedKey=(J)=>{this.registers[x]=J;this.paused=false}}break;case 21:{this.delayTimer=this.registers[x]}break;case 24:{this.soundTimer=this.registers[x]}break;case 30:{this.i+=this.registers[x]}break;case 41:{this.i=this.registers[x]*5}break;case 51:{let J=this.registers[x];this.memory[this.i]=Math.floor(J/100);this.memory[this.i+1]=Math.floor(J%100/10);this.memory[this.i+2]=Math.floor(J%10)}break;case 85:{for(let J=0;J<=x;J++){this.memory[this.i+J]=this.registers[J]}}break;case 101:{for(let J=0;J<=x;J++){this.registers[J]=this.memory[this.i+J]}}break}}break}}}class h{cpu;constructor(F,x,q){this.cpu=new Y(F,x,q);this.interval=0;this.now=0;this.lastTime=0;this.elapsed=0}loadRomBufferInMemory(F){for(let x=0;x<F.length;x++){this.cpu.memory[U+x]=F[x]}}async fetchRom(F="corax.ch8"){const x=await fetch(`roms/${F}`);const q=await x.arrayBuffer();this.loadRomBufferInMemory(new Uint8Array(q))}init(){this.interval=1000/C;this.lastTime=Date.now();this.cpu.loadFontsetInMemory();this.fetchRom()}run(){this.now=Date.now();this.elapsed=this.now-this.lastTime;if(this.elapsed>this.interval){this.lastTime=this.now;this.cpu.cycle()}requestAnimationFrame(this.run.bind(this))}}var S=new M;var V=new X;var E=new Z;var N=new h(S,V,E);N.init();N.run();
